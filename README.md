# patsy

Command-line client for the preservation asset tracking system (PATSy)

## Project Branches

This project uses the "GitHub Flow" branching model (see
<https://confluence.umd.edu/display/LIB/GitHub+Flow+Model+for+Kubernetes+configuration+%28k8s-%29+repositories>)

The "main" branch represents version 2 (v2) of the "patsy-db" codebase, which
is incompatible with the "legacy" version 1 (v1) codebase.

Any work on the legacy patsy-db v1 application should be performed on the
"main-v1" branch.

## Development Setup

See [docs/DevelopmentSetup.md](docs/DevelopmentSetup.md).

## Database Setup

PATSy can be used with either a SQLite or Postgres database. The database
to use is be specified by the "--database" command-line argument,
or via a "PATSY_DATABASE" environment variable.

## PATSy Commands

The "--help" flag provides information about available commands and arguments:

```bash
$ patsy --help
```

The "--help" flag, coupled with a specific command shows additional information
about that command:

```bash
$ patsy load --help
```

### Common Arguments

#### "database" argument

The "--database" argument is used to specify the database the command should
run against.

##### SQLite

For SQLite databases, this is typically just the filename of the SQLite database
file. For example, to set up an empty SQLite file named "patsy-db.sqlite":

```bash
$ patsy --database patsy-db.sqlite schema
```

##### Postgres

For Postgres databases, a database connection URL with the following format
is used:

```text
postgresql+psycopg2://<USER>:<PASSWORD>@<ADDRESS>:<PORT>/<DATABASE>
```

where:

* \<USER> - the name of the database user
* \<PASSWORD> - the database password for the user
* \<ADDRESS> - the hostname/IP address of the database
* \<PORT> - the port number (typically "5432" for Postgres)
* \<DATABASE> - the name of the database to connect to, typically "patsy"

**Note:** The database specified in \<DATABASE> must exist.

For example, to connect to a Postgres database named "patsy" on "localhost"
with a username of "postgres", and a password of "password":

```bash
$ patsy --database postgresql+psycopg2://postgres:password@localhost:5432/patsy <COMMAND>
```

where \<COMMAND> is the PATSy command to run.

#### PATSY_DATABASE environment variable

The "--database" argument can be omitted if a "PATSY_DATABASE" environment variable
has been defined.

For SQLite, simply specify the filename of the SQLite file. For example, for
"patsy-db.sqlite":

```bash
$ export PATSY_DATABASE=patsy-db.sqlite
```

For Postgres, use the database connection URL. For example, using the
Postgres database connection URL for a local Docker container:

```bash
$ export PATSY_DATABASE=postgresql+psycopg2://postgres:password@localhost:5432/patsy
```

The "--database" argument can still be passed in to temporarily override the
environment variable.

### "schema" command

Creates the database schema.

```bash
$ patsy --database <DATABASE> schema
```

Typically needs only needs to be done once, when the database is created.

### "load" command

Loads an "inventory" CSV file into the database.

```bash
$ patsy --database <DATABASE> load <INVENTORY_CSV_FILE>
```

The "inventory" CSV file is typically generated by the "preserve"
(<https://github.com/umd-lib/preserve>) or "aws-archiver"
(<https://github.com/umd-lib/aws-archiver>) tools.

Each row of the CSV file contains information about the batch, accession,
and (optionally) location information about a preservation asset.

An accession is uniquely identified by its batch, and relative path (relpath)
fields. If an accession already exists, the "load" command will NOT update
the accession (even if the accession information in the CSV file is different).
Location information for an existing accession will be added, unless the
location already exists for that accession.

### "checksum" command

Retrieves checksums (MD5 (default), SHA1, or SHA256) for one or more accessions,
looked up by storage location.

```bash
$ patsy --database <DATABASE> checksum [--md5|--sha1|--sha256] [LOCATION [LOCATIONS...]]
```

Creates output like this:

```bash
088be3fe9a8fd2a7e70e66a602828766  libdc-archivebucket-17lowbw7m2av1/Archive000Florence/Florence.mpg
fe84e91e0a06906773a5c19a2e9620d9  libdc-archivebucket-17lowbw7m2av1/Archive000Football1/19461130-FB-002-2Qtr.mpg
9876f8c92e16b73c662a39b23409d0a0  libdc-archivebucket-17lowbw7m2av1/Archive000Football1/19461130-FB-003-2Half.mpg
```

Instead of listing locations on the command line, the checksum command
also accepts a CSV file with columns "location" and "destination". If
the "destination" is present, it is used for the second column. Assuming
that the "destination" refers to an actual path on a local file
system, this output can then be fed to `md5sum -c` (or other
algorithm-appropriate checksum verification tool).

```bash
$ patsy --database <DATABASE> checksum [--md5|--sha1|--sha256] --file <CSV_FILE>
```

### "sync" command

Store locations of accessions in ApTrust to PATSy.

```bash
$ patsy --database <DATABASE> sync --name <API-NAME> --key <API-KEY> [--timebefore|--timeafter] <YEAR-MONTH-DAY>
```

The \<API-NAME> and \<API-KEY> are the X-Pharos-API-User and X-Pharos_API-Key
respectively. They are required for the command. These can be provided in the
command or can be added as command-line arguments:

```bash
$ export X_PHAROS_KEY=your-email
$ export X_PHAROS_KEY=the-secret-key
```

Providing the parameters has more priority than providing them as command-line
arguments.

The "timebefore" and "timeafter" parameters are dates provided to specify what
bags to access from ApTrust. The dates should be formatted in
"year-month-day" format (####-##-##).

## Database Migrations

PATSy uses the "Alembic" (<https://alembic.sqlalchemy.org/en/latest/>) migration
tool to handle updates to the database schema.

Specifying the database must be done either by:

* Setting up the "PATSY_DATABASE" environment variable, or
* Running the "alembic" command with the "-x database=<DATABASE>" flag, with
  \<DATABASE> being the same value passed to the "--database" argument for
  PATSy commands. For example:

    ```bash
    $ alembic -x database=postgresql+psycopg2://postgres:password@localhost:5432/patsy upgrade head
    ```

The alembic command will fail with a "patsy.database.DatabaseNotSetError" error
if the database has not been set.

### Run the database migrations

To run the database migrations:

```bash
$ alembic upgrade head
```

### To add a new migration:

```bash
$ alembic revision -m "<MIGRATION_DESCRIPTION>"
```

where \<MIGRATION_DESCRIPTION> is a short description of the migration, such
as "create local types table". This description will be included as part of the
migration filename.

### Auto-generating migrations

**Note:** Auto-generating migrations has significant limitations. See
<https://alembic.sqlalchemy.org/en/latest/autogenerate.html>.

Alembic can attempt to "auto-generate" migrations. To do this, first modify the
"declarative base" in "patsy/model.py", and then run the following command:

```bash
$ alembic revision --autogenerate -m "<MIGRATION_DESCRIPTION>"
```

where \<MIGRATION_DESCRIPTION> is a short description of the migration, such
as "create local types table". This description will be included as part of the
migration filename.

## License

See the [LICENSE](LICENSE) file for license rights and limitations.
